{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ashis/Desktop/HeritagePlanner/lib/agentic-engine.ts"],"sourcesContent":["import type { ChatMessage, Trek, ChatContext } from \"./types\"\n\ninterface AgentState {\n  conversationPhase: \"greeting\" | \"preference-gathering\" | \"trek-selection\" | \"itinerary-planning\" | \"booking\"\n  extractedContext: ChatContext\n  recommendedTreks: Trek[]\n  selectedTrek: Trek | null\n  itineraryGenerated: boolean\n}\n\nexport class TrekAgentEngine {\n  private state: AgentState\n  private treks: Trek[]\n\n  constructor(treks: Trek[]) {\n    this.treks = treks\n    this.state = {\n      conversationPhase: \"greeting\",\n      extractedContext: {},\n      recommendedTreks: [],\n      selectedTrek: null,\n      itineraryGenerated: false,\n    }\n  }\n\n  extractPreferences(messages: ChatMessage[]): ChatContext {\n    const combined = messages\n      .map((m) => m.content)\n      .join(\" \")\n      .toLowerCase()\n\n    const context: ChatContext = {}\n\n    // Budget detection\n    if (combined.includes(\"budget\") || combined.includes(\"cheap\") || combined.includes(\"affordable\")) {\n      context.budget = \"budget\"\n    } else if (combined.includes(\"luxury\") || combined.includes(\"premium\") || combined.includes(\"expensive\")) {\n      context.budget = \"luxury\"\n    } else if (combined.includes(\"mid\") || combined.includes(\"moderate\")) {\n      context.budget = \"moderate\"\n    }\n\n    // Fitness level detection\n    if (\n      combined.includes(\"beginner\") ||\n      combined.includes(\"easy\") ||\n      combined.includes(\"leisurely\") ||\n      combined.includes(\"relaxed\")\n    ) {\n      context.fitnessLevel = \"beginner\"\n    } else if (\n      combined.includes(\"challenging\") ||\n      combined.includes(\"athletic\") ||\n      combined.includes(\"difficult\") ||\n      combined.includes(\"expedition\")\n    ) {\n      context.fitnessLevel = \"advanced\"\n    } else if (combined.includes(\"fit\") || combined.includes(\"moderate\") || combined.includes(\"regular\")) {\n      context.fitnessLevel = \"moderate\"\n    }\n\n    // Culture/interest detection\n    context.interests = []\n    if (combined.includes(\"culture\") || combined.includes(\"traditional\")) context.interests.push(\"culture\")\n    if (combined.includes(\"mountain\") || combined.includes(\"peak\") || combined.includes(\"himalaya\"))\n      context.interests.push(\"mountain\")\n    if (combined.includes(\"village\") || combined.includes(\"community\")) context.interests.push(\"village\")\n    if (combined.includes(\"temple\") || combined.includes(\"spiritual\") || combined.includes(\"religious\"))\n      context.interests.push(\"spiritual\")\n    if (combined.includes(\"photography\")) context.interests.push(\"photography\")\n\n    // Season detection\n    if (combined.includes(\"spring\") || combined.includes(\"april\") || combined.includes(\"march\")) {\n      context.season = \"spring\"\n    } else if (combined.includes(\"autumn\") || combined.includes(\"october\") || combined.includes(\"september\")) {\n      context.season = \"autumn\"\n    } else if (combined.includes(\"winter\") || combined.includes(\"december\")) {\n      context.season = \"winter\"\n    }\n\n    // Specific culture detection\n    const cultureKeywords = {\n      sherpa: [\"sherpa\", \"solu\", \"khumbu\", \"everest\"],\n      newari: [\"newari\", \"kathmandu\", \"valley\", \"bhaktapur\"],\n      tamang: [\"tamang\", \"langtang\", \"helambu\"],\n      sunuwar: [\"sunuwar\", \"sakela\", \"panchthar\"],\n      magar: [\"magar\", \"dhulikhel\", \"nuwakot\"],\n    }\n\n    for (const [culture, keywords] of Object.entries(cultureKeywords)) {\n      if (keywords.some((kw) => combined.includes(kw))) {\n        context.culture = culture\n        break\n      }\n    }\n\n    return context\n  }\n\n  recommendTreks(context: ChatContext): Trek[] {\n    let recommendations = [...this.treks]\n\n    if (context.fitnessLevel) {\n      if (context.fitnessLevel === \"beginner\") {\n        recommendations = recommendations.filter((t) => t.difficulty === \"Easy\")\n      } else if (context.fitnessLevel === \"advanced\") {\n        recommendations = recommendations.filter((t) => t.difficulty === \"Challenging\" || t.difficulty === \"Moderate\")\n      }\n    }\n\n    if (context.season) {\n      recommendations = recommendations.filter((t) => {\n        const season = context.season\n        if (season === \"spring\") return t.bestSeason.includes(\"Mar\") || t.bestSeason.includes(\"Apr\")\n        if (season === \"autumn\") return t.bestSeason.includes(\"Sep\") || t.bestSeason.includes(\"Oct\")\n        if (season === \"winter\") return t.bestSeason.includes(\"Dec\") || t.bestSeason.includes(\"Jan\")\n        return true\n      })\n    }\n\n    if (context.culture) {\n      const cultureMap: Record<string, string> = {\n        sherpa: \"Sherpa\",\n        newari: \"Newari\",\n        tamang: \"Tamang\",\n        sunuwar: \"Sunuwar\",\n        magar: \"Magar\",\n      }\n      const cultureValue = cultureMap[context.culture]\n      if (cultureValue) {\n        recommendations = recommendations.filter((t) => t.culture === cultureValue)\n      }\n    }\n\n    return recommendations.slice(0, 3)\n  }\n\n  updateConversationPhase(messages: ChatMessage[], selectedTrek: Trek | null) {\n    const messageCount = messages.length\n    const lastMessage = messages[messages.length - 1]?.content.toLowerCase() || \"\"\n\n    if (selectedTrek && lastMessage.includes(\"itinerary\")) {\n      this.state.conversationPhase = \"itinerary-planning\"\n    } else if (selectedTrek) {\n      this.state.conversationPhase = \"trek-selection\"\n    } else if (messageCount > 3 && (lastMessage.includes(\"prefer\") || lastMessage.includes(\"budget\"))) {\n      this.state.conversationPhase = \"preference-gathering\"\n    } else {\n      this.state.conversationPhase = \"greeting\"\n    }\n  }\n\n  async reason(messages: ChatMessage[], selectedTrek: Trek | null): Promise<AgentState> {\n    this.state.extractedContext = this.extractPreferences(messages)\n    this.state.recommendedTreks = this.recommendTreks(this.state.extractedContext)\n    this.state.selectedTrek = selectedTrek\n    this.updateConversationPhase(messages, selectedTrek)\n\n    return this.state\n  }\n\n  getState() {\n    return this.state\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ashis/Desktop/HeritagePlanner/lib/ai-config.ts"],"sourcesContent":["export const AI_CONFIG = {\n  provider: process.env.QWEN_API_KEY ? \"qwen\" : \"fallback\",\n  apiKey: process.env.QWEN_API_KEY || \"\",\n  model: \"deepinfra/qwen-2.5-72b-instruct\",\n  temperature: 0.8,\n  maxTokens: 800,\n  isConfigured: !!process.env.QWEN_API_KEY,\n} as const\n\nexport function getAIProvider() {\n  return AI_CONFIG.provider\n}\n\nexport function isQwenReady() {\n  return AI_CONFIG.isConfigured\n}\n\nexport const buildQwenPrompt = (messages: Array<{ role: string; content: string }>, selectedTrek: any) => {\n  const conversationHistory = messages.map((m) => `${m.role === \"user\" ? \"User\" : \"Mincha\"}: ${m.content}`).join(\"\\n\")\n\n  return `You are Mincha, a curious and enthusiastic Nepali travel guide with deep expertise in cultural trekking experiences. \nYou help travelers plan authentic 3-day treks through Nepal's diverse cultural regions.\n\nYour personality:\n- Warm, engaging, and genuinely interested in travelers' stories\n- Knowledgeable about Nepali cultures (Sherpa, Newari, Tamang, Sunuwar, etc.)\n- Practical about logistics, budget, and fitness levels\n- Passionate about authentic cultural experiences\n\nCurrent conversation:\n${conversationHistory}\n\n${selectedTrek ? `Selected Trek: ${selectedTrek.name} (${selectedTrek.culture} culture in ${selectedTrek.region})` : \"\"}\n\nInstructions:\n1. Understand the user's travel style, budget, and interests from their messages\n2. Recommend treks that match their preferences\n3. For selected treks, create detailed 3-day itineraries with activities, accommodation, and local guides\n4. Always be honest about difficulty levels and physical requirements\n5. Suggest booking services (hotels, homestays, guides) that align with their budget\n6. Mention WhatsApp booking options for local partners\n7. Share cultural insights and tips about local customs\n8. Keep responses concise (2-3 sentences max for engagement, longer only when requested)\n\nRespond naturally and conversationally. If the user asks for an itinerary, format it clearly with day-by-day breakdown.`\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAO,MAAM,YAAY;IACvB,UAAU,QAAQ,GAAG,CAAC,YAAY,GAAG,SAAS;IAC9C,QAAQ,QAAQ,GAAG,CAAC,YAAY,IAAI;IACpC,OAAO;IACP,aAAa;IACb,WAAW;IACX,cAAc,CAAC,CAAC,QAAQ,GAAG,CAAC,YAAY;AAC1C;AAEO,SAAS;IACd,OAAO,UAAU,QAAQ;AAC3B;AAEO,SAAS;IACd,OAAO,UAAU,YAAY;AAC/B;AAEO,MAAM,kBAAkB,CAAC,UAAoD;IAClF,MAAM,sBAAsB,SAAS,GAAG,CAAC,CAAC,IAAM,GAAG,EAAE,IAAI,KAAK,SAAS,SAAS,SAAS,EAAE,EAAE,EAAE,OAAO,EAAE,EAAE,IAAI,CAAC;IAE/G,OAAO,CAAC;;;;;;;;;;AAUV,EAAE,oBAAoB;;AAEtB,EAAE,eAAe,CAAC,eAAe,EAAE,aAAa,IAAI,CAAC,EAAE,EAAE,aAAa,OAAO,CAAC,YAAY,EAAE,aAAa,MAAM,CAAC,CAAC,CAAC,GAAG,GAAG;;;;;;;;;;;;uHAYD,CAAC;AACxH"}},
    {"offset": {"line": 242, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ashis/Desktop/HeritagePlanner/app/api/chat/route.ts"],"sourcesContent":["import { generateText } from \"ai\"\nimport { createDeepInfra } from \"@ai-sdk/deepinfra\"\nimport type { Trek, ChatMessage as ChatMessageType } from \"@/lib/types\"\nimport { TrekAgentEngine } from \"@/lib/agentic-engine\"\nimport { buildQwenPrompt, isQwenReady } from \"@/lib/ai-config\"\n\nconst treksData = {\n  treks: [\n    {\n      id: \"sunuwar-1\",\n      name: \"Sakela Trek\",\n      culture: \"Sunuwar\",\n      region: \"Panchthar\",\n      difficulty: \"Moderate\" as const,\n      bestSeason: \"Oct-Nov, Mar-Apr\",\n      description: \"Experience authentic Sunuwar traditions in the eastern hills\",\n      season: \"Spring & Autumn\",\n      highlights: [\"Sacred Sakela festival\", \"Sunuwar villages\", \"Traditional homestays\"],\n    },\n    {\n      id: \"sherpa-1\",\n      name: \"Solu Khumbu Trek\",\n      culture: \"Sherpa\",\n      region: \"Solu-Khumbu\",\n      difficulty: \"Challenging\" as const,\n      bestSeason: \"Sep-Oct, Mar-Apr\",\n      description: \"Trek through Sherpa villages with stunning Himalayan views\",\n      season: \"Autumn & Spring\",\n      highlights: [\"Sherpa culture\", \"Mountain views\", \"Buddhist monasteries\"],\n    },\n    {\n      id: \"newari-1\",\n      name: \"Nuwakot Trek\",\n      culture: \"Newari\",\n      region: \"Kathmandu Valley\",\n      difficulty: \"Easy\" as const,\n      bestSeason: \"Oct-Nov, Feb-Apr\",\n      description: \"Explore ancient Newari architecture and traditions\",\n      season: \"Winter & Spring\",\n      highlights: [\"Newari villages\", \"Ancient temples\", \"Traditional pottery\"],\n    },\n    {\n      id: \"tamang-1\",\n      name: \"Tamang Heritage Trek\",\n      culture: \"Tamang\",\n      region: \"Langtang\",\n      difficulty: \"Moderate\" as const,\n      bestSeason: \"Oct-Nov, Mar-Apr\",\n      description: \"Immerse in Tamang mountain culture\",\n      season: \"Autumn & Spring\",\n      highlights: [\"Tamang villages\", \"Mountain views\", \"Local hospitality\"],\n    },\n  ],\n}\n\nfunction generateFallbackResponse(\n  engine: TrekAgentEngine,\n  messages: ChatMessageType[],\n  selectedTrek: Trek | null,\n): string {\n  const state = engine.getState()\n  const lastUserMessage = messages.filter((m) => m.role === \"user\").slice(-1)[0]?.content || \"\"\n  const userLower = lastUserMessage.toLowerCase()\n\n  // Trek-specific responses\n  if (selectedTrek) {\n    const responses = [\n      `Wonderful choice! The ${selectedTrek.name} offers an incredible journey through ${selectedTrek.culture} culture. This trek is ${selectedTrek.difficulty === \"Easy\" ? \"gentle and suitable for all\" : selectedTrek.difficulty === \"Moderate\" ? \"moderately challenging\" : \"quite challenging\"}. Best visited during ${selectedTrek.bestSeason}. Would you like me to create a detailed 3-day itinerary with accommodation and guide recommendations?`,\n      `Perfect! I know the ${selectedTrek.name} trek well. The highlights include ${selectedTrek.highlights.slice(0, 2).join(\" and \")}. With your ${state.extractedContext.budget || \"moderate\"} budget, you have wonderful homestay options. Shall I design your complete itinerary now?`,\n      `Excellent! The ${selectedTrek.name} is unforgettable. Your ${state.extractedContext.fitnessLevel || \"moderate\"} fitness level pairs perfectly with this experience. Ready to lock in dates and book your guide?`,\n    ]\n    return responses[Math.floor(Math.random() * responses.length)]\n  }\n\n  // Preference gathering responses\n  if (\n    userLower.includes(\"budget\") ||\n    userLower.includes(\"fitness\") ||\n    userLower.includes(\"prefer\") ||\n    userLower.includes(\"interested\")\n  ) {\n    const recs = state.recommendedTreks\n    const responses = [\n      `Perfect! Based on what you've shared, I'd recommend: ${recs.map((t) => t.name).join(\", \")}. Which of these calls to you?`,\n      `Great insights! Here are my top picks for you: ${recs\n        .slice(0, 2)\n        .map((t) => `${t.name} (${t.culture})`)\n        .join(\" or \")}. Tell me which sounds best!`,\n      `You sound like an adventurer! These match your style: ${recs.map((t) => t.name).join(\", \")}. Which trek interests you most?`,\n    ]\n    return responses[Math.floor(Math.random() * responses.length)]\n  }\n\n  // General engagement responses\n  const generalResponses = [\n    \"I'd love to help! Tell me about your ideal trek - your budget, fitness level, and which Nepali cultures fascinate you?\",\n    \"That's wonderful! To find your perfect match, what's your approximate budget and do you prefer challenging mountain hikes or leisurely cultural walks?\",\n    \"Great question! Are you drawn to specific cultures, or shall I tell you about Sherpa, Newari, Tamang, and Sunuwar traditions?\",\n    \"Exciting! What time of year are you thinking, and what's your fitness level like?\",\n  ]\n  return generalResponses[Math.floor(Math.random() * generalResponses.length)]\n}\n\nasync function generateChatResponse(messages: ChatMessageType[], selectedTrek: Trek | null): Promise<string> {\n  const engine = new TrekAgentEngine(treksData.treks as Trek[])\n  await engine.reason(messages, selectedTrek)\n\n  // If Qwen is configured, use it for richer responses\n  if (isQwenReady()) {\n    const prompt = buildQwenPrompt(\n      messages.map((m) => ({ role: m.role, content: m.content })),\n      selectedTrek,\n    )\n    \n    // Try DeepInfra first if DEEPINFRA_API_KEY is explicitly set\n    const deepInfraApiKey = process.env.DEEPINFRA_API_KEY\n    if (deepInfraApiKey) {\n      try {\n        console.log(\"[v0] Using DeepInfra/Qwen AI for response generation\")\n        const deepInfra = createDeepInfra({ apiKey: deepInfraApiKey })\n        // Convert prompt to messages format for better compatibility\n        const result = await generateText({\n          model: deepInfra(\"deepinfra/qwen-2.5-72b-instruct\"),\n          messages: [{ role: \"user\", content: prompt }],\n          maxOutputTokens: 800,\n          temperature: 0.8,\n        })\n        return result.text\n      } catch (error) {\n        console.log(\"[v0] DeepInfra call failed, falling back to DashScope:\", error)\n        // Fall through to DashScope fallback\n      }\n    }\n    \n    // Use DashScope API (QWEN_API_KEY or DASHSCOPE_API_KEY)\n    const dashScopeApiKey = process.env.DASHSCOPE_API_KEY || process.env.QWEN_API_KEY\n    if (dashScopeApiKey) {\n      try {\n        console.log(\"[v0] Using DashScope/Qwen AI for response generation\")\n        const res = await fetch(\"https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions\", {\n          method: \"POST\",\n          headers: {\n            \"Authorization\": `Bearer ${dashScopeApiKey}`,\n            \"Content-Type\": \"application/json\",\n          },\n          body: JSON.stringify({\n            model: \"qwen-plus\",\n            messages: [{ role: \"user\", content: prompt }],\n            max_tokens: 800,\n            temperature: 0.8,\n          }),\n        })\n        \n        if (!res.ok) {\n          throw new Error(`DashScope API error: ${res.status} ${res.statusText}`)\n        }\n        \n        const data = await res.json()\n        if (data.choices?.[0]?.message?.content) {\n          return data.choices[0].message.content.trim()\n        }\n        throw new Error(\"No content in DashScope response\")\n      } catch (error) {\n        console.log(\"[v0] DashScope call failed, using intelligent fallback:\", error)\n        return generateFallbackResponse(engine, messages, selectedTrek)\n      }\n    }\n    \n    // If no API keys are available, use fallback\n    console.log(\"[v0] No Qwen API keys configured, using intelligent fallback\")\n    return generateFallbackResponse(engine, messages, selectedTrek)\n  }\n\n  return generateFallbackResponse(engine, messages, selectedTrek)\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const { messages, selectedTrek } = body\n\n    if (!Array.isArray(messages) || messages.length === 0) {\n      return Response.json({ error: \"Invalid messages format\" }, { status: 400 })\n    }\n\n    const engine = new TrekAgentEngine(treksData.treks as Trek[])\n    await engine.reason(messages, selectedTrek)\n    const state = engine.getState()\n\n    const response = await generateChatResponse(messages, selectedTrek)\n\n    console.log(\"[v0] Agent phase:\", state.conversationPhase)\n    console.log(\"[v0] Extracted context:\", state.extractedContext)\n    console.log(\"[v0] Using Qwen:\", isQwenReady())\n\n    return Response.json({\n      response,\n      suggestedTreks: state.recommendedTreks,\n      generatedItinerary: null,\n      agentState: {\n        phase: state.conversationPhase,\n        context: state.extractedContext,\n      },\n    })\n  } catch (error) {\n    console.error(\"[v0] Chat API error:\", error)\n    return Response.json(\n      {\n        response: \"Let me gather my thoughts for a moment. Could you rephrase that in a different way?\",\n        suggestedTreks: [],\n        generatedItinerary: null,\n      },\n      { status: 200 },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}